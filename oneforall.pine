//@version=6
indicator("One for All", shorttitle="OFA", overlay=true, max_lines_count=500, max_boxes_count=500, max_labels_count=500)

// ══════════════════════════════════════════════════════════════════════════════
// ONE FOR ALL - ICT-Focused TradingView Indicator
// ══════════════════════════════════════════════════════════════════════════════
// Version: 3.4.0 | Author: theCodeman | Date: 2025-12-05
//
// PURPOSE: All-in-one indicator for Inner Circle Trader (ICT) analysis with
// sessions, kill zones, previous period levels, and higher timeframe candles.
//
// CURRENT STATUS: Phase 3B Complete (HTF Candles with FVG/VI detection)
//
// KEY FEATURES:
// • Customizable watermark with symbol/timeframe display
// • Quick Toggles section at top of settings for instant feature control (NEW in v3.4.0)
// • Status Dashboard with quick visual reference for enabled features
// • Trading sessions (Asian/London/NY) with high/low tracking
// • Kill zones with customizable time ranges
// • Previous period H/L lines (Daily/Weekly/Monthly) with custom styles
// • Higher timeframe candles (5 slots) with FVG/VI detection and trace lines
// • HTF timer and interval labels with custom daily open options
//
// PHASE COMPLETION:
// ✓ Phase 1: Watermark foundation
// ✓ Phase 2: Sessions & kill zones
// ✓ Phase 3: Previous period H/L with custom styles
// ✓ Phase 3B: HTF candles with FVG/VI detection
// ○ Phase 3C: Market structure (liquidity zones, order blocks) - Planned
//
// RECENT UPDATES (v3.4.0):
// • NEW: Quick Toggles - All 5 master feature toggles at top of settings panel for instant access
// • No more scrolling through settings to enable/disable features
// • Optimized Quick Toggles section shows first when settings panel opens
// • FIXED: HTF Candles master toggle now properly controls all HTF rendering (bug fix)
// • Enhanced user experience with streamlined settings organization
//
// For detailed version history, see CHANGELOG.md
// For development guide, see CLAUDE.md
// ══════════════════════════════════════════════════════════════════════════════


// ══════════════════════════════════════════════════════════════════════════════
// INPUT GROUPS
// ══════════════════════════════════════════════════════════════════════════════

// Define input group constants for organized UI
var string GRP_SETTINGS = "═══ SETTINGS ═══"
var string GRP_QUICK_TOGGLES = "═══ QUICK TOGGLES ═══"
var string GRP_WATERMARK = "═══ WATERMARK ═══"
var string GRP_WATERMARK_CONTENT = "Watermark Content"
var string GRP_WATERMARK_STYLE = "Watermark Style"
var string GRP_SESSIONS = "═══ SESSIONS ═══"
var string GRP_SESSION_STYLE = "Session Style"
var string GRP_KILLZONES = "═══ KILL ZONES ═══"
var string GRP_KZ_STYLE = "Kill Zone Style"
var string GRP_PREV_PERIODS = "═══ PREVIOUS PERIOD H/L ═══"
var string GRP_PREV_STYLE = "Previous Period Style"
var string GRP_HTF = "═══ HTF CANDLES ═══"
var string GRP_HTF_SLOTS = "HTF Slots Configuration"
var string GRP_HTF_STYLE = "HTF Candle Style"
var string GRP_HTF_LABELS = "HTF Label Settings"
var string GRP_HTF_IMBALANCE = "HTF Imbalance Detection"
var string GRP_HTF_TRACE = "HTF Trace Lines"
var string GRP_STATUS_DASHBOARD = "═══ STATUS DASHBOARD ═══"


// ══════════════════════════════════════════════════════════════════════════════
// CONSTANTS
// ══════════════════════════════════════════════════════════════════════════════

// Default transparency values
var int TRANSP_WATERMARK = 50
var int TRANSP_KILLZONE_BOX = 70
var int TRANSP_KILLZONE_TEXT = 50
var int TRANSP_SESSION_BG = 90

// ══════════════════════════════════════════════════════════════════════════════
// GLOBAL SETTINGS
// ══════════════════════════════════════════════════════════════════════════════

max_days = input.int(1, "Drawing Limit (Days)", minval=1, maxval=10, tooltip="Maximum number of days to display for sessions and kill zones. Keeps chart clean and performant.", group=GRP_SETTINGS)

gmt_tz = input.string('GMT-5', "Timezone", options=['GMT-12','GMT-11','GMT-10','GMT-9','GMT-8','GMT-7','GMT-6','GMT-5','GMT-4','GMT-3','GMT-2','GMT-1','GMT+0','GMT+1','GMT+2','GMT+3','GMT+4','GMT+5','GMT+6','GMT+7','GMT+8','GMT+9','GMT+10','GMT+11','GMT+12','GMT+13','GMT+14'], tooltip="Select your timezone. All session times will be displayed in this timezone.\n\nNote: GMT does not automatically adjust for Daylight Saving Time.", group=GRP_SETTINGS)


// ══════════════════════════════════════════════════════════════════════════════
// QUICK TOGGLES - Master Feature Switches
// ══════════════════════════════════════════════════════════════════════════════

showWatermark = input.bool(true, "Enable/Disable Watermark", tooltip="Toggle watermark visibility on/off", group=GRP_QUICK_TOGGLES)

showSessions = input.bool(true, "Enable/Disable Sessions", tooltip="Master toggle for all session displays", group=GRP_QUICK_TOGGLES)

showKillZones = input.bool(true, "Enable/Disable Kill Zones", tooltip="Master toggle for all kill zone displays", group=GRP_QUICK_TOGGLES)

show_prev_periods = input.bool(true, "Enable/Disable Previous Period H/L", tooltip="Master toggle for daily/weekly/monthly high/low lines", group=GRP_QUICK_TOGGLES)

show_htf_candles = input.bool(true, "Enable/Disable HTF Candles", tooltip="Master toggle for all HTF candle displays", group=GRP_QUICK_TOGGLES)


// ══════════════════════════════════════════════════════════════════════════════
// WATERMARK SETTINGS
// ══════════════════════════════════════════════════════════════════════════════

// Content Settings

titleText = input.string("Name", "Title Text", tooltip="Custom title text for line 1", group=GRP_WATERMARK_CONTENT)

showSymbol = input.bool(true, "Show Symbol", inline="content01", tooltip="Display current symbol ticker in title", group=GRP_WATERMARK_CONTENT)

showTimeframe = input.bool(true, "Show Timeframe", inline="content01", tooltip="Display current chart timeframe in title", group=GRP_WATERMARK_CONTENT)

subtitle1 = input.string("Patience", "Subtitle 1", inline="content02", tooltip="First subtitle cell", group=GRP_WATERMARK_CONTENT)

subtitle2 = input.string("Confidence", "Subtitle 2", inline="content02", tooltip="Second subtitle cell", group=GRP_WATERMARK_CONTENT)

subtitle3 = input.string("Execution", "Subtitle 3", inline="content02", tooltip="Third subtitle cell", group=GRP_WATERMARK_CONTENT)

// Style Settings
textColor = input.color(color.new(color.white, 0), "Text Color", inline="style01", tooltip="Choose watermark text color", group=GRP_WATERMARK_STYLE)

transparency = input.int(TRANSP_WATERMARK, "Transparency", minval=0, maxval=100, inline="style01", tooltip="0 = fully opaque, 100 = fully transparent", group=GRP_WATERMARK_STYLE)

fontSize = input.string(size.normal, "Font Size", options=[size.auto, size.tiny, size.small, size.normal, size.large, size.huge], inline="style02", tooltip="Select watermark text size", group=GRP_WATERMARK_STYLE)

position = input.string("Center", "Position", options=["Left", "Center", "Right"], inline="style02", tooltip="Horizontal alignment of watermark", group=GRP_WATERMARK_STYLE)


// ══════════════════════════════════════════════════════════════════════════════
// STATUS DASHBOARD SETTINGS
// ══════════════════════════════════════════════════════════════════════════════

show_status_dashboard = input.bool(false, "Enable Status Dashboard", tooltip="Display a quick reference box showing which features are currently enabled/disabled", group=GRP_STATUS_DASHBOARD)

status_position = input.string("Bottom Right", "Position", options=["Top Left", "Top Center", "Top Right", "Middle Left", "Middle Center", "Middle Right", "Bottom Left", "Bottom Center", "Bottom Right"], tooltip="Choose where to display the status dashboard on your chart", group=GRP_STATUS_DASHBOARD)

status_bg_transp = input.int(85, "Background Transparency", minval=0, maxval=100, tooltip="Adjust background transparency (0=opaque, 100=invisible)", group=GRP_STATUS_DASHBOARD)


// ══════════════════════════════════════════════════════════════════════════════
// SESSIONS SETTINGS
// ══════════════════════════════════════════════════════════════════════════════

// Session Configuration
show_asian = input.bool(true, "", inline="sess_asian", group=GRP_SESSIONS)
asian_txt = input.string("As", "", inline="sess_asian", group=GRP_SESSIONS)
asian_ses = input.session("1900-0400", "", inline="sess_asian", tooltip="Asian session time range in HHMM-HHMM format", group=GRP_SESSIONS)
asian_css = input.color(color.new(color.yellow, 0), "", inline="sess_asian", group=GRP_SESSIONS)

show_london = input.bool(true, "", inline="sess_london", group=GRP_SESSIONS)
london_txt = input.string("Lo", "", inline="sess_london", group=GRP_SESSIONS)
london_ses = input.session("0300-1200", "", inline="sess_london", tooltip="London session time range in HHMM-HHMM format", group=GRP_SESSIONS)
london_css = input.color(color.new(color.blue, 0), "", inline="sess_london", group=GRP_SESSIONS)

show_ny = input.bool(true, "", inline="sess_ny", group=GRP_SESSIONS)
ny_txt = input.string("NY", "", inline="sess_ny", group=GRP_SESSIONS)
ny_ses = input.session("0800-1600", "", inline="sess_ny", tooltip="New York session time range in HHMM-HHMM format", group=GRP_SESSIONS)
ny_css = input.color(color.new(color.green, 0), "", inline="sess_ny", group=GRP_SESSIONS)

// Display Options
show_session_range = input.bool(true, "Session Ranges", inline="sess_opt01", tooltip="Show session high/low boxes", group=GRP_SESSIONS)
show_session_highs = input.bool(true, "High/Low Lines", inline="sess_opt01", tooltip="Show horizontal lines at session highs and lows", group=GRP_SESSIONS)

show_session_open = input.bool(false, "Open Markers", inline="sess_opt02", tooltip="Mark session open with vertical line", group=GRP_SESSIONS)
show_session_close = input.bool(false, "Close Markers", inline="sess_opt02", tooltip="Mark session close with vertical line", group=GRP_SESSIONS)

// Style Settings
session_bg_transp = input.int(TRANSP_SESSION_BG, "Range Transparency", minval=0, maxval=100, tooltip="Session box background transparency", group=GRP_SESSION_STYLE)

show_session_outline = input.bool(true, "Range Outline", tooltip="Show border on session range boxes", group=GRP_SESSION_STYLE)

show_session_labels = input.bool(true, "Range Labels", tooltip="Show session name labels on boxes", group=GRP_SESSION_STYLE)

session_line_width = input.int(1, "Line Width", minval=1, maxval=5, inline="sess_style01", tooltip="Session line thickness", group=GRP_SESSION_STYLE)

session_line_style = input.string("Dotted", "Line Style", options=["Solid", "Dashed", "Dotted"], inline="sess_style01", group=GRP_SESSION_STYLE)

session_label_position = input.string("Above", "Label Position", options=["Right", "Left", "Above", "Below"], tooltip="Position of session high/low labels relative to the line", group=GRP_SESSION_STYLE)


// ══════════════════════════════════════════════════════════════════════════════
// KILL ZONES SETTINGS
// ══════════════════════════════════════════════════════════════════════════════

// Kill Zone Configuration
show_kz_text = input.bool(true, "Display Text Labels", tooltip="Show text labels on kill zones", group=GRP_KILLZONES)

use_asian_kz = input.bool(true, "", inline="kz_asian", group=GRP_KILLZONES)
asian_kz_txt = input.string("Asia", "", inline="kz_asian", group=GRP_KILLZONES)
asian_kz_ses = input.session("2000-0000", "", inline="kz_asian", tooltip="Asian kill zone time range in HHMM-HHMM format", group=GRP_KILLZONES)
asian_kz_css = input.color(color.new(color.black, 0), "", inline="kz_asian", group=GRP_KILLZONES)

use_london_kz = input.bool(true, "", inline="kz_london", group=GRP_KILLZONES)
london_kz_txt = input.string("London", "", inline="kz_london", group=GRP_KILLZONES)
london_kz_ses = input.session("0300-0500", "", inline="kz_london", tooltip="London kill zone time range in HHMM-HHMM format", group=GRP_KILLZONES)
london_kz_css = input.color(color.new(color.black, 0), "", inline="kz_london", group=GRP_KILLZONES)

use_nyam_kz = input.bool(true, "", inline="kz_nyam", group=GRP_KILLZONES)
nyam_kz_txt = input.string("NY AM", "", inline="kz_nyam", group=GRP_KILLZONES)
nyam_kz_ses = input.session("0930-1100", "", inline="kz_nyam", tooltip="NY AM kill zone time range in HHMM-HHMM format", group=GRP_KILLZONES)
nyam_kz_css = input.color(color.new(color.black, 0), "", inline="kz_nyam", group=GRP_KILLZONES)

use_nylu_kz = input.bool(true, "", inline="kz_nylu", group=GRP_KILLZONES)
nylu_kz_txt = input.string("NY Lunch", "", inline="kz_nylu", group=GRP_KILLZONES)
nylu_kz_ses = input.session("1200-1300", "", inline="kz_nylu", tooltip="NY Lunch kill zone time range in HHMM-HHMM format", group=GRP_KILLZONES)
nylu_kz_css = input.color(color.new(color.yellow, 0), "", inline="kz_nylu", group=GRP_KILLZONES)

use_nypm_kz = input.bool(true, "", inline="kz_nypm", group=GRP_KILLZONES)
nypm_kz_txt = input.string("NY PM", "", inline="kz_nypm", group=GRP_KILLZONES)
nypm_kz_ses = input.session("1330-1600", "", inline="kz_nypm", tooltip="NY PM kill zone time range in HHMM-HHMM format", group=GRP_KILLZONES)
nypm_kz_css = input.color(color.new(color.black, 0), "", inline="kz_nypm", group=GRP_KILLZONES)

// Style Settings
kz_box_transp = input.int(TRANSP_KILLZONE_BOX, "Box Transparency", minval=0, maxval=100, tooltip="Kill zone box transparency", group=GRP_KZ_STYLE)

kz_text_transp = input.int(TRANSP_KILLZONE_TEXT, "Text Transparency", minval=0, maxval=100, tooltip="Kill zone label transparency", group=GRP_KZ_STYLE)


// ══════════════════════════════════════════════════════════════════════════════
// PREVIOUS PERIOD H/L SETTINGS
// ══════════════════════════════════════════════════════════════════════════════

// Period Configuration
show_daily_hl = input.bool(true, "Daily H/L", inline="period01", tooltip="Previous daily high/low", group=GRP_PREV_PERIODS)
daily_lookback = input.int(1, "Lookback", inline="period01", minval=1, maxval=10, tooltip="Number of previous days to display", group=GRP_PREV_PERIODS)

show_weekly_hl = input.bool(false, "Weekly H/L", inline="period02", tooltip="Previous weekly high/low", group=GRP_PREV_PERIODS)
weekly_lookback = input.int(1, "Lookback", inline="period02", minval=1, maxval=5, tooltip="Number of previous weeks to display", group=GRP_PREV_PERIODS)

show_monthly_hl = input.bool(false, "Monthly H/L", inline="period03", tooltip="Previous monthly high/low", group=GRP_PREV_PERIODS)
monthly_lookback = input.int(1, "Lookback", inline="period03", minval=1, maxval=3, tooltip="Number of previous months to display", group=GRP_PREV_PERIODS)

// Style Settings
daily_color = input.color(color.new(color.black, 0), "Daily Color", inline="color01", group=GRP_PREV_STYLE)
weekly_color = input.color(color.new(color.black, 0), "Weekly Color", inline="color01", group=GRP_PREV_STYLE)
monthly_color = input.color(color.new(color.black, 0), "Monthly Color", inline="color01", group=GRP_PREV_STYLE)

daily_line_style = input.string("Dashed", "Daily Line Style", options=["Solid", "Dashed", "Dotted"], inline="style01", tooltip="Choose line style for daily high/low", group=GRP_PREV_STYLE)
weekly_line_style = input.string("Dashed", "Weekly Line Style", options=["Solid", "Dashed", "Dotted"], inline="style01", tooltip="Choose line style for weekly high/low", group=GRP_PREV_STYLE)
monthly_line_style = input.string("Dashed", "Monthly Line Style", options=["Solid", "Dashed", "Dotted"], inline="style02", tooltip="Choose line style for monthly high/low", group=GRP_PREV_STYLE)

daily_line_width = input.int(1, "Daily Width", minval=1, maxval=5, inline="width01", group=GRP_PREV_STYLE)
weekly_line_width = input.int(1, "Weekly Width", minval=1, maxval=5, inline="width01", group=GRP_PREV_STYLE)
monthly_line_width = input.int(1, "Monthly Width", minval=1, maxval=5, inline="width01", group=GRP_PREV_STYLE)

// Label Customization
show_period_labels = input.bool(true, "Show Period Labels", tooltip="Display text labels for previous period high/low lines", group=GRP_PREV_STYLE)

daily_high_label = input.string("PDH", "Daily High", inline="label01", tooltip="Label text for previous daily high", group=GRP_PREV_STYLE)
daily_low_label = input.string("PDL", "Daily Low", inline="label01", tooltip="Label text for previous daily low", group=GRP_PREV_STYLE)

weekly_high_label = input.string("PWH", "Weekly High", inline="label02", tooltip="Label text for previous weekly high", group=GRP_PREV_STYLE)
weekly_low_label = input.string("PWL", "Weekly Low", inline="label02", tooltip="Label text for previous weekly low", group=GRP_PREV_STYLE)

monthly_high_label = input.string("PMH", "Monthly High", inline="label03", tooltip="Label text for previous monthly high", group=GRP_PREV_STYLE)
monthly_low_label = input.string("PML", "Monthly Low", inline="label03", tooltip="Label text for previous monthly low", group=GRP_PREV_STYLE)

period_label_position = input.string("Right", "Label Position", options=["Right", "Left"], tooltip="Position of period labels relative to the line", group=GRP_PREV_STYLE)


// ══════════════════════════════════════════════════════════════════════════════
// HTF CANDLES - TYPE DEFINITIONS
// ══════════════════════════════════════════════════════════════════════════════

type Candle
    float o
    float c
    float h
    float l
    int o_time
    int o_idx
    int c_idx
    int h_idx
    int l_idx
    string dow
    box body
    line wick_up
    line wick_down
    label dow_label

type Trace
    line o
    line c
    line h
    line l
    label o_l
    label c_l
    label h_l
    label l_l

type Imbalance
    box b
    int idx

type CandleSettings
    bool show
    string htf
    int max_display

type HTFSettings
    int max_sets
    color bull_body
    color bull_border
    color bull_wick
    color bear_body
    color bear_border
    color bear_wick
    int offset
    int buffer
    int htf_buffer
    int width
    bool use_custom_daily
    string custom_daily
    bool daily_name
    bool trace_show
    color trace_o_color
    string trace_o_style
    int trace_o_size
    color trace_c_color
    string trace_c_style
    int trace_c_size
    color trace_h_color
    string trace_h_style
    int trace_h_size
    color trace_l_color
    string trace_l_style
    int trace_l_size
    string trace_anchor
    bool label_show
    color label_color
    string label_size
    string label_position
    string label_alignment
    bool fvg_show
    color fvg_color
    bool vi_show
    color vi_color
    bool htf_label_show
    color htf_label_color
    string htf_label_size
    bool htf_timer_show
    color htf_timer_color
    string htf_timer_size
    color dow_color
    string dow_size

type CandleSet
    array<Candle> candles
    array<Imbalance> imbalances
    CandleSettings settings
    label tfNameTop
    label tfNameBottom
    label tfTimerTop
    label tfTimerBottom


// ══════════════════════════════════════════════════════════════════════════════
// HTF CANDLES - VARIABLE INITIALIZATION
// ══════════════════════════════════════════════════════════════════════════════

HTFSettings htf_settings = HTFSettings.new()

var CandleSettings SettingsHTF1 = CandleSettings.new()
var CandleSettings SettingsHTF2 = CandleSettings.new()
var CandleSettings SettingsHTF3 = CandleSettings.new()
var CandleSettings SettingsHTF4 = CandleSettings.new()
var CandleSettings SettingsHTF5 = CandleSettings.new()

var array<Candle> candles_1 = array.new<Candle>(0)
var array<Candle> candles_2 = array.new<Candle>(0)
var array<Candle> candles_3 = array.new<Candle>(0)
var array<Candle> candles_4 = array.new<Candle>(0)
var array<Candle> candles_5 = array.new<Candle>(0)

var array<Imbalance> imbalances_1 = array.new<Imbalance>()
var array<Imbalance> imbalances_2 = array.new<Imbalance>()
var array<Imbalance> imbalances_3 = array.new<Imbalance>()
var array<Imbalance> imbalances_4 = array.new<Imbalance>()
var array<Imbalance> imbalances_5 = array.new<Imbalance>()

var CandleSet htf1 = CandleSet.new()
htf1.settings := SettingsHTF1
htf1.candles := candles_1
htf1.imbalances := imbalances_1

var CandleSet htf2 = CandleSet.new()
htf2.settings := SettingsHTF2
htf2.candles := candles_2
htf2.imbalances := imbalances_2

var CandleSet htf3 = CandleSet.new()
htf3.settings := SettingsHTF3
htf3.candles := candles_3
htf3.imbalances := imbalances_3

var CandleSet htf4 = CandleSet.new()
htf4.settings := SettingsHTF4
htf4.candles := candles_4
htf4.imbalances := imbalances_4

var CandleSet htf5 = CandleSet.new()
htf5.settings := SettingsHTF5
htf5.candles := candles_5
htf5.imbalances := imbalances_5

var Trace htf_trace = Trace.new()
color color_transparent = #ffffff00


// ══════════════════════════════════════════════════════════════════════════════
// HTF CANDLES - INPUT SETTINGS
// ══════════════════════════════════════════════════════════════════════════════

htf1.settings.show := input.bool(true, 'HTF 1', inline='htf1', group=GRP_HTF_SLOTS)
htf_1 = input.timeframe('5', '', inline='htf1', group=GRP_HTF_SLOTS)
htf1.settings.htf := htf_1
htf1.settings.max_display := input.int(10, '', inline='htf1', tooltip="Maximum candles to display for HTF 1", group=GRP_HTF_SLOTS)

htf2.settings.show := input.bool(true, 'HTF 2', inline='htf2', group=GRP_HTF_SLOTS)
htf_2 = input.timeframe('15', '', inline='htf2', group=GRP_HTF_SLOTS)
htf2.settings.htf := htf_2
htf2.settings.max_display := input.int(10, '', inline='htf2', tooltip="Maximum candles to display for HTF 2", group=GRP_HTF_SLOTS)

htf3.settings.show := input.bool(true, 'HTF 3', inline='htf3', group=GRP_HTF_SLOTS)
htf_3 = input.timeframe('60', '', inline='htf3', group=GRP_HTF_SLOTS)
htf3.settings.htf := htf_3
htf3.settings.max_display := input.int(10, '', inline='htf3', tooltip="Maximum candles to display for HTF 3", group=GRP_HTF_SLOTS)

htf4.settings.show := input.bool(true, 'HTF 4', inline='htf4', group=GRP_HTF_SLOTS)
htf_4 = input.timeframe('240', '', inline='htf4', group=GRP_HTF_SLOTS)
htf4.settings.htf := htf_4
htf4.settings.max_display := input.int(10, '', inline='htf4', tooltip="Maximum candles to display for HTF 4", group=GRP_HTF_SLOTS)

htf5.settings.show := input.bool(true, 'HTF 5', inline='htf5', group=GRP_HTF_SLOTS)
htf_5 = input.timeframe('1D', '', inline='htf5', group=GRP_HTF_SLOTS)
htf5.settings.htf := htf_5
htf5.settings.max_display := input.int(10, '', inline='htf5', tooltip="Maximum candles to display for HTF 5", group=GRP_HTF_SLOTS)

htf_settings.max_sets := input.int(5, 'Limit to next HTFs only', minval=1, maxval=5, tooltip="Only show the next N higher timeframes above current chart timeframe", group=GRP_HTF_SLOTS)
htf_settings.use_custom_daily := input.bool(false, 'Custom daily candle open', inline='customdaily', tooltip="Use custom daily candle open time (US markets)", group=GRP_HTF_SLOTS)
htf_settings.custom_daily := input.string('Midnight', '', options=['Midnight', '8:30', '9:30'], inline='customdaily', group=GRP_HTF_SLOTS)

htf_settings.bull_body := input.color(color.new(color.green, 10), 'Bullish Body', inline='body', group=GRP_HTF_STYLE)
htf_settings.bear_body := input.color(color.new(color.red, 10), 'Bearish Body', inline='body', group=GRP_HTF_STYLE)
htf_settings.bull_border := input.color(color.new(color.black, 10), 'Bullish Border', inline='borders', group=GRP_HTF_STYLE)
htf_settings.bear_border := input.color(color.new(color.black, 10), 'Bearish Border', inline='borders', group=GRP_HTF_STYLE)
htf_settings.bull_wick := input.color(color.new(color.black, 10), 'Bullish Wick', inline='wick', group=GRP_HTF_STYLE)
htf_settings.bear_wick := input.color(color.new(color.black, 10), 'Bearish Wick', inline='wick', group=GRP_HTF_STYLE)
htf_settings.offset := input.int(10, 'Padding from current candles', minval=1, tooltip="Horizontal offset from current bar", group=GRP_HTF_STYLE)
htf_settings.buffer := input.int(1, 'Space between candles', minval=1, maxval=4, tooltip="Bar spacing between HTF candles", group=GRP_HTF_STYLE)
htf_settings.htf_buffer := input.int(10, 'Space between HTF sets', minval=1, maxval=10, tooltip="Bar spacing between different HTF timeframes", group=GRP_HTF_STYLE)
htf_settings.width := input.int(1, 'Candle Width', minval=1, maxval=4, tooltip="Width of HTF candle bodies", group=GRP_HTF_STYLE) * 2

htf_settings.htf_label_show := input.bool(true, 'HTF Label', inline='HTFlabel', tooltip="Show HTF timeframe name label", group=GRP_HTF_LABELS)
htf_settings.htf_label_color := input.color(color.new(color.black, 10), '', inline='HTFlabel', group=GRP_HTF_LABELS)
htf_settings.htf_label_size := input.string(size.large, '', [size.tiny, size.small, size.normal, size.large, size.huge], inline='HTFlabel', group=GRP_HTF_LABELS)
htf_settings.label_position := input.string("Both", 'Label Positions', options=['Both', 'Top', 'Bottom'], tooltip="Where to show HTF labels", group=GRP_HTF_LABELS)
htf_settings.label_alignment := input.string("Align", "Label Alignment", options=['Align', 'Follow Candles'], tooltip="Align all HTF labels or follow individual candle sets", group=GRP_HTF_LABELS)
htf_settings.htf_timer_show := input.bool(true, 'Remaining time', inline='timer', tooltip="Show time remaining until HTF candle close", group=GRP_HTF_LABELS)
htf_settings.htf_timer_color := input.color(color.new(color.black, 10), '', inline='timer', group=GRP_HTF_LABELS)
htf_settings.htf_timer_size := input.string(size.normal, '', [size.tiny, size.small, size.normal, size.large, size.huge], inline='timer', group=GRP_HTF_LABELS)
htf_settings.daily_name := input.bool(false, 'Interval Value', inline='dow', tooltip="Show day of week or time on candles", group=GRP_HTF_LABELS)
htf_settings.dow_color := input.color(color.black, '', inline='dow', group=GRP_HTF_LABELS)
htf_settings.dow_size := input.string(size.small, '', [size.tiny, size.small, size.normal, size.large, size.huge], inline='dow', group=GRP_HTF_LABELS)
htf_settings.label_show := input.bool(false, 'Price Label', inline='label', tooltip="Show price labels on trace lines", group=GRP_HTF_LABELS)
htf_settings.label_color := input.color(color.new(color.black, 10), '', inline='label', group=GRP_HTF_LABELS)
htf_settings.label_size := input.string(size.small, '', [size.tiny, size.small, size.normal, size.large, size.huge], inline='label', group=GRP_HTF_LABELS)

htf_settings.fvg_show := input.bool(true, 'Fair Value Gap', inline='fvg', tooltip="Detect and highlight Fair Value Gaps", group=GRP_HTF_IMBALANCE)
htf_settings.fvg_color := input.color(color.new(color.gray, 80), '', inline='fvg', group=GRP_HTF_IMBALANCE)
htf_settings.vi_show := input.bool(true, 'Volume Imbalance', inline='vi', tooltip="Detect and highlight Volume Imbalances", group=GRP_HTF_IMBALANCE)
htf_settings.vi_color := input.color(color.new(color.red, 50), '', inline='vi', group=GRP_HTF_IMBALANCE)

htf_settings.trace_show := input.bool(false, 'Show Trace Lines', tooltip="Draw lines connecting HTF OHLC to formation bars", group=GRP_HTF_TRACE)
htf_settings.trace_o_color := input.color(color.new(color.gray, 50), 'Open', inline='1', group=GRP_HTF_TRACE)
htf_settings.trace_o_style := input.string('····', '', options=['⎯⎯⎯', '----', '····'], inline='1', group=GRP_HTF_TRACE)
htf_settings.trace_o_size := input.int(1, '', options=[1, 2, 3, 4], inline='1', group=GRP_HTF_TRACE)
htf_settings.trace_c_color := input.color(color.new(color.gray, 50), 'Close', inline='2', group=GRP_HTF_TRACE)
htf_settings.trace_c_style := input.string('····', '', options=['⎯⎯⎯', '----', '····'], inline='2', group=GRP_HTF_TRACE)
htf_settings.trace_c_size := input.int(1, '', options=[1, 2, 3, 4], inline='2', group=GRP_HTF_TRACE)
htf_settings.trace_h_color := input.color(color.new(color.gray, 50), 'High', inline='3', group=GRP_HTF_TRACE)
htf_settings.trace_h_style := input.string('····', '', options=['⎯⎯⎯', '----', '····'], inline='3', group=GRP_HTF_TRACE)
htf_settings.trace_h_size := input.int(1, '', options=[1, 2, 3, 4], inline='3', group=GRP_HTF_TRACE)
htf_settings.trace_l_color := input.color(color.new(color.gray, 50), 'Low', inline='4', group=GRP_HTF_TRACE)
htf_settings.trace_l_style := input.string('····', '', options=['⎯⎯⎯', '----', '····'], inline='4', group=GRP_HTF_TRACE)
htf_settings.trace_l_size := input.int(1, '', options=[1, 2, 3, 4], inline='4', group=GRP_HTF_TRACE)
htf_settings.trace_anchor := input.string('First Timeframe', 'Anchor to', options=['First Timeframe', 'Last Timeframe'], tooltip="Which HTF set to draw trace lines for", group=GRP_HTF_TRACE)


// ══════════════════════════════════════════════════════════════════════════════
// HELPER FUNCTIONS
// ══════════════════════════════════════════════════════════════════════════════

// Get line style constant
get_line_style() =>
    session_line_style == "Dashed" ? line.style_dashed : session_line_style == "Dotted" ? line.style_dotted : line.style_solid

// Get label style constant based on user selection
get_label_style() =>
    session_label_position == "Left" ? label.style_label_right : session_label_position == "Above" ? label.style_label_down : session_label_position == "Below" ? label.style_label_up : label.style_label_left

// Get period line style constant from input
get_period_line_style(style_input) =>
    style_input == "Dashed" ? line.style_dashed : style_input == "Dotted" ? line.style_dotted : line.style_solid

// Get period label style constant based on user selection
get_period_label_style() =>
    period_label_position == "Left" ? label.style_label_right : label.style_label_left

// Get status dashboard position constant from string input
get_status_position(pos) =>
    pos == "Top Left" ? position.top_left : pos == "Top Center" ? position.top_center : pos == "Top Right" ? position.top_right : pos == "Middle Left" ? position.middle_left : pos == "Middle Center" ? position.middle_center : pos == "Middle Right" ? position.middle_right : pos == "Bottom Left" ? position.bottom_left : pos == "Bottom Center" ? position.bottom_center : position.bottom_right

// HTF Helper methods
HTFLineStyle(string style) => style == '⎯⎯⎯' ? line.style_solid : style == '----' ? line.style_dashed : line.style_dotted

DayofWeek(int index) => index == 1 ? 'S' : index == 2 ? 'M' : index == 3 ? 'T' : index == 4 ? 'W' : index == 5 ? 'T' : index == 6 ? 'F' : index == 7 ? 'S' : ''

ValidTimeframe(string HTF) =>
    timeframe.in_seconds(HTF) > timeframe.in_seconds()

RemainingTime(string HTF) =>
    now = time
    tf = timeframe.in_seconds(HTF) * 1000
    sinceOpen = (now - time(HTF, '0000-0000:23456', gmt_tz)) % tf
    remaining = tf - sinceOpen
    days = math.floor(remaining / 86400000)
    hours = math.floor((remaining % 86400000) / 3600000)
    minutes = math.floor((remaining % 3600000) / 60000)
    daysStr = days > 0 ? str.tostring(days) + 'D ' : ''
    hoursStr = hours > 0 ? str.tostring(hours) + 'H ' : ''
    minutesStr = str.tostring(minutes) + 'M'
    daysStr + hoursStr + minutesStr

HTFName(string HTF) =>
    tf = timeframe.in_seconds(HTF)
    days = tf / 86400
    hours = tf / 3600
    minutes = tf / 60
    days >= 1 ? str.tostring(days) + 'D' : hours >= 1 ? str.tostring(hours) + 'H' : str.tostring(minutes) + 'M'

HTFEnabled() =>
    count = 0
    if htf1.settings.show
        count += 1
    if htf2.settings.show
        count += 1
    if htf3.settings.show
        count += 1
    if htf4.settings.show
        count += 1
    if htf5.settings.show
        count += 1
    count

CandleSetHigh(array<Candle> candles, float h) =>
    _high = h
    if candles.size() > 0
        for i = 0 to candles.size() - 1
            candle = candles.get(i)
            if candle.h > _high
                _high := candle.h
    _high

CandleSetLow(array<Candle> candles, float l) =>
    _low = l
    if candles.size() > 0
        for i = 0 to candles.size() - 1
            candle = candles.get(i)
            if candle.l < _low
                _low := candle.l
    _low

CandlesHigh() =>
    _high = high
    if htf1.settings.show
        _high := CandleSetHigh(htf1.candles, _high)
    if htf2.settings.show
        _high := CandleSetHigh(htf2.candles, _high)
    if htf3.settings.show
        _high := CandleSetHigh(htf3.candles, _high)
    if htf4.settings.show
        _high := CandleSetHigh(htf4.candles, _high)
    if htf5.settings.show
        _high := CandleSetHigh(htf5.candles, _high)
    _high

CandlesLow() =>
    _low = low
    if htf1.settings.show
        _low := CandleSetLow(htf1.candles, _low)
    if htf2.settings.show
        _low := CandleSetLow(htf2.candles, _low)
    if htf3.settings.show
        _low := CandleSetLow(htf3.candles, _low)
    if htf4.settings.show
        _low := CandleSetLow(htf4.candles, _low)
    if htf5.settings.show
        _low := CandleSetLow(htf5.candles, _low)
    _low

// ══════════════════════════════════════════════════════════════════════════════
// HTF CANDLES - CANDLESET METHODS
// ══════════════════════════════════════════════════════════════════════════════

method UpdateTime(CandleSet candleSet, int offset) =>
    if htf_settings.htf_timer_show and (barstate.isrealtime or barstate.islast)
        string tmr = '(' + RemainingTime(candleSet.settings.htf) + ')'
        if not na(candleSet.tfTimerTop)
            candleSet.tfTimerTop.set_text(tmr)
        if not na(candleSet.tfTimerBottom)
            candleSet.tfTimerBottom.set_text(tmr)
    candleSet

method Reorder(CandleSet candleSet, int offset) =>
    size = candleSet.candles.size()
    if size > 0
        for i = size - 1 to 0 by 1
            Candle candle = candleSet.candles.get(i)
            t_buffer = offset + (htf_settings.width + htf_settings.buffer) * (size - i - 1)
            box.set_left(candle.body, bar_index + t_buffer)
            box.set_right(candle.body, bar_index + htf_settings.width + t_buffer)
            line.set_x1(candle.wick_up, bar_index + htf_settings.width / 2 + t_buffer)
            line.set_x2(candle.wick_up, bar_index + htf_settings.width / 2 + t_buffer)
            line.set_x1(candle.wick_down, bar_index + htf_settings.width / 2 + t_buffer)
            line.set_x2(candle.wick_down, bar_index + htf_settings.width / 2 + t_buffer)
            if htf_settings.daily_name
                if not na(candle.dow_label)
                    candle.dow_label.set_y(candle.h)
                    candle.dow_label.set_x(bar_index + htf_settings.width / 2 + t_buffer)
                    candle.dow_label.set_text(candle.dow)
                else
                    candle.dow_label := label.new(bar_index + htf_settings.width / 2 + t_buffer, candle.h, candle.dow, color=color_transparent, textcolor=htf_settings.dow_color, style=label.style_label_down, size=htf_settings.dow_size)
    top = 0.0
    bottom = 0.0
    if htf_settings.label_alignment == 'Align'
        top := CandlesHigh()
        bottom := CandlesLow()
    if htf_settings.label_alignment == 'Follow Candles'
        top := CandleSetHigh(candleSet.candles, 0)
        bottom := CandleSetLow(candleSet.candles, top)
    left = bar_index + offset + (htf_settings.width + htf_settings.buffer) * (size - 1) / 2
    if htf_settings.htf_label_show
        string lblt = HTFName(candleSet.settings.htf)
        string lbll = lblt
        if htf_settings.htf_timer_show
            lblt := lblt + '\n'
            lbll := '\n' + lbll
        if htf_settings.daily_name
            lblt := lblt + '\n'
        string tmr = '(' + RemainingTime(candleSet.settings.htf) + ')' + (htf_settings.daily_name ? '\n' : '')
        if htf_settings.label_position == 'Both' or htf_settings.label_position == 'Top'
            if not na(candleSet.tfNameTop)
                candleSet.tfNameTop.set_xy(left, top)
            else
                candleSet.tfNameTop := label.new(left, top, lblt, color=color_transparent, textcolor=htf_settings.htf_label_color, style=label.style_label_down, size=htf_settings.htf_label_size)
            if htf_settings.htf_timer_show
                if not na(candleSet.tfTimerTop)
                    candleSet.tfTimerTop.set_xy(left, top)
                else
                    candleSet.tfTimerTop := label.new(left, top, tmr, color=color_transparent, textcolor=htf_settings.htf_timer_color, style=label.style_label_down, size=htf_settings.htf_timer_size)
        if htf_settings.label_position == 'Both' or htf_settings.label_position == 'Bottom'
            if not na(candleSet.tfNameBottom)
                candleSet.tfNameBottom.set_xy(left, bottom)
            else
                candleSet.tfNameBottom := label.new(left, bottom, lbll, color=color_transparent, textcolor=htf_settings.htf_label_color, style=label.style_label_up, size=htf_settings.htf_label_size)
            if htf_settings.htf_timer_show
                if htf_settings.htf_timer_show
                    if not na(candleSet.tfTimerBottom)
                        candleSet.tfTimerBottom.set_xy(left, bottom)
                    else
                        candleSet.tfTimerBottom := label.new(left, bottom, tmr, color=color_transparent, textcolor=htf_settings.htf_timer_color, style=label.style_label_up, size=htf_settings.htf_timer_size)
    candleSet

method FindImbalance(CandleSet candleSet) =>
    if barstate.isrealtime or barstate.islast
        if candleSet.imbalances.size() > 0
            for i = candleSet.imbalances.size() - 1 to 0 by 1
                Imbalance del = candleSet.imbalances.get(i)
                box.delete(del.b)
                candleSet.imbalances.pop()
        if candleSet.candles.size() > 3 and htf_settings.fvg_show
            for i = 0 to candleSet.candles.size() - 3 by 1
                candle1 = candleSet.candles.get(i)
                candle2 = candleSet.candles.get(i + 2)
                candle3 = candleSet.candles.get(i + 1)
                if candle1.l > candle2.h and math.min(candle1.o, candle1.c) > math.max(candle2.o, candle2.c)
                    Imbalance imb = Imbalance.new()
                    imb.b := box.new(box.get_left(candle2.body), candle2.h, box.get_right(candle1.body), candle1.l, bgcolor=htf_settings.fvg_color, border_color=color_transparent, xloc=xloc.bar_index)
                    candleSet.imbalances.push(imb)
                if candle1.h < candle2.l and math.max(candle1.o, candle1.c) < math.min(candle2.o, candle2.c)
                    Imbalance imb = Imbalance.new()
                    imb.b := box.new(box.get_right(candle1.body), candle1.h, box.get_left(candle2.body), candle2.l, bgcolor=htf_settings.fvg_color, border_color=color_transparent)
                    candleSet.imbalances.push(imb)
                box temp = box.copy(candle3.body)
                box.delete(candle3.body)
                candle3.body := temp
                candle3.body
        if candleSet.candles.size() > 2 and htf_settings.vi_show
            for i = 0 to candleSet.candles.size() - 2 by 1
                candle1 = candleSet.candles.get(i)
                candle2 = candleSet.candles.get(i + 1)
                if candle1.l < candle2.h and math.min(candle1.o, candle1.c) > math.max(candle2.o, candle2.c)
                    Imbalance imb = Imbalance.new()
                    imb.b := box.new(box.get_left(candle2.body), math.min(candle1.o, candle1.c), box.get_right(candle1.body), math.max(candle2.o, candle2.c), bgcolor=htf_settings.vi_color, border_color=color_transparent)
                    candleSet.imbalances.push(imb)
                if candle1.h > candle2.l and math.max(candle1.o, candle1.c) < math.min(candle2.o, candle2.c)
                    Imbalance imb = Imbalance.new()
                    imb.b := box.new(box.get_right(candle1.body), math.min(candle2.o, candle2.c), box.get_left(candle2.body), math.max(candle1.o, candle1.c), bgcolor=htf_settings.vi_color, border_color=color_transparent)
                    candleSet.imbalances.push(imb)
    candleSet

method Monitor(CandleSet candleSet) =>
    HTFBarTime = time(candleSet.settings.htf, gmt_tz)
    isNewHTFCandle = ta.change(HTFBarTime) > 0
    if htf_settings.use_custom_daily
        int _830 = 0
        if isNewHTFCandle
            _830 := timestamp(gmt_tz, year(time), month(time), dayofmonth(time), 0, 0) + 30600000
        if candleSet.settings.htf == '1D'
            if htf_settings.custom_daily == 'Midnight'
                isNewHTFCandle := dayofweek(time, gmt_tz) != dayofweek(time - (time - time[1]), gmt_tz)
            if htf_settings.custom_daily == '8:30'
                isNewHTFCandle := not na(time(timeframe.period, "0830-0831:123456", gmt_tz)) and na(time(timeframe.period, "0830-0831:123456", gmt_tz)[1])
            if htf_settings.custom_daily == '9:30'
                isNewHTFCandle := not na(time(timeframe.period, "0930-0931:123456", gmt_tz)) and na(time(timeframe.period, "0930-0931:123456", gmt_tz)[1])
    if isNewHTFCandle
        Candle candle = Candle.new()
        candle.o := open
        candle.c := close
        candle.h := high
        candle.l := low
        candle.o_time := time
        candle.o_idx := bar_index
        candle.c_idx := bar_index
        candle.h_idx := bar_index
        candle.l_idx := bar_index
        candle.dow := candleSet.settings.htf == '1D' ? DayofWeek(dayofweek(time_tradingday, gmt_tz)) : str.tonumber(candleSet.settings.htf) < 60 ? str.format_time(candle.o_time, 'm', gmt_tz) : str.tonumber(candleSet.settings.htf) >= 60 ? str.format_time(candle.o_time, 'H', gmt_tz) : candleSet.settings.htf == '1M' ? str.format_time(candle.o_time, 'M', gmt_tz) : ''
        bull = candle.c > candle.o
        candle.body := box.new(bar_index, math.max(candle.o, candle.c), bar_index + 2, math.min(candle.o, candle.c), bull ? htf_settings.bull_border : htf_settings.bear_border, 1, bgcolor=bull ? htf_settings.bull_body : htf_settings.bear_body)
        candle.wick_up := line.new(bar_index + 1, candle.h, bar_index, math.max(candle.o, candle.c), color=bull ? htf_settings.bull_wick : htf_settings.bear_wick)
        candle.wick_down := line.new(bar_index + 1, math.min(candle.o, candle.c), bar_index, candle.l, color=bull ? htf_settings.bull_wick : htf_settings.bear_wick)
        candleSet.candles.unshift(candle)
        if candleSet.candles.size() > candleSet.settings.max_display
            Candle delCandle = array.pop(candleSet.candles)
            box.delete(delCandle.body)
            line.delete(delCandle.wick_up)
            line.delete(delCandle.wick_down)
            delCandle.dow_label.delete()
    candleSet

method Update(CandleSet candleSet, int offset, bool showTrace) =>
    if candleSet.candles.size() > 0
        Candle candle = candleSet.candles.first()
        candle.h_idx := high > candle.h ? bar_index : candle.h_idx
        candle.h := high > candle.h ? high : candle.h
        candle.l_idx := low < candle.l ? bar_index : candle.l_idx
        candle.l := low < candle.l ? low : candle.l
        candle.c := close
        candle.c_idx := bar_index
        bull = candle.c > candle.o
        box.set_top(candle.body, candle.o)
        box.set_bottom(candle.body, candle.c)
        box.set_bgcolor(candle.body, bull ? htf_settings.bull_body : htf_settings.bear_body)
        box.set_border_color(candle.body, bull ? htf_settings.bull_border : htf_settings.bear_border)
        line.set_color(candle.wick_up, bull ? htf_settings.bull_wick : htf_settings.bear_wick)
        line.set_color(candle.wick_down, bull ? htf_settings.bull_wick : htf_settings.bear_wick)
        line.set_y1(candle.wick_up, candle.h)
        line.set_y2(candle.wick_up, math.max(candle.o, candle.c))
        line.set_y1(candle.wick_down, candle.l)
        line.set_y2(candle.wick_down, math.min(candle.o, candle.c))
        if barstate.isrealtime or barstate.islast
            candleSet.Reorder(offset)
            if htf_settings.trace_show and showTrace
                if bar_index - candle.o_idx < 5000
                    if na(htf_trace.o)
                        htf_trace.o := line.new(candle.o_idx, candle.o, box.get_left(candle.body), candle.o, xloc=xloc.bar_index, color=htf_settings.trace_o_color, style=HTFLineStyle(htf_settings.trace_o_style), width=htf_settings.trace_o_size)
                        htf_trace.o
                    else
                        line.set_xy1(htf_trace.o, candle.o_idx, candle.o)
                        line.set_xy2(htf_trace.o, box.get_left(candle.body), candle.o)
                    if htf_settings.label_show
                        if na(htf_trace.o_l)
                            htf_trace.o_l := label.new(box.get_right(candle.body), candle.o, str.tostring(candle.o), textalign=text.align_center, style=label.style_label_left, size=htf_settings.label_size, color=color_transparent, textcolor=htf_settings.label_color)
                            htf_trace.o_l
                        else
                            label.set_xy(htf_trace.o_l, box.get_right(candle.body), candle.o)
                            label.set_text(htf_trace.o_l, str.tostring(candle.o))
                if bar_index - candle.c_idx < 5000
                    if na(htf_trace.c)
                        htf_trace.c := line.new(candle.c_idx, candle.c, box.get_left(candle.body), candle.c, xloc=xloc.bar_index, color=htf_settings.trace_c_color, style=HTFLineStyle(htf_settings.trace_c_style), width=htf_settings.trace_c_size)
                        htf_trace.c
                    else
                        line.set_xy1(htf_trace.c, candle.c_idx, candle.c)
                        line.set_xy2(htf_trace.c, box.get_left(candle.body), candle.c)
                    if htf_settings.label_show
                        if na(htf_trace.c_l)
                            htf_trace.c_l := label.new(box.get_right(candle.body), candle.c, str.tostring(candle.c), textalign=text.align_center, style=label.style_label_left, size=htf_settings.label_size, color=color_transparent, textcolor=htf_settings.label_color)
                            htf_trace.c_l
                        else
                            label.set_xy(htf_trace.c_l, box.get_right(candle.body), candle.c)
                            label.set_text(htf_trace.c_l, str.tostring(candle.c))
                if bar_index - candle.h_idx < 5000
                    if na(htf_trace.h)
                        htf_trace.h := line.new(candle.h_idx, candle.h, line.get_x1(candle.wick_up), candle.h, xloc=xloc.bar_index, color=htf_settings.trace_h_color, style=HTFLineStyle(htf_settings.trace_h_style), width=htf_settings.trace_h_size)
                        htf_trace.h
                    else
                        line.set_xy1(htf_trace.h, candle.h_idx, candle.h)
                        line.set_xy2(htf_trace.h, line.get_x1(candle.wick_up), candle.h)
                    if htf_settings.label_show
                        if na(htf_trace.h_l)
                            htf_trace.h_l := label.new(box.get_right(candle.body), candle.h, str.tostring(candle.h), textalign=text.align_center, style=label.style_label_left, size=htf_settings.label_size, color=color_transparent, textcolor=htf_settings.label_color)
                            htf_trace.h_l
                        else
                            label.set_xy(htf_trace.h_l, box.get_right(candle.body), candle.h)
                            label.set_text(htf_trace.h_l, str.tostring(candle.h))
                if bar_index - candle.l_idx < 5000
                    if na(htf_trace.l)
                        htf_trace.l := line.new(candle.l_idx, candle.l, line.get_x1(candle.wick_down), candle.l, xloc=xloc.bar_index, color=htf_settings.trace_l_color, style=HTFLineStyle(htf_settings.trace_l_style), width=htf_settings.trace_l_size)
                        htf_trace.l
                    else
                        line.set_xy1(htf_trace.l, candle.l_idx, candle.l)
                        line.set_xy2(htf_trace.l, line.get_x1(candle.wick_down), candle.l)
                    if htf_settings.label_show
                        if na(htf_trace.l_l)
                            htf_trace.l_l := label.new(box.get_right(candle.body), candle.l, str.tostring(candle.l), textalign=text.align_center, style=label.style_label_left, size=htf_settings.label_size, color=color_transparent, textcolor=htf_settings.label_color)
                            htf_trace.l_l
                        else
                            label.set_xy(htf_trace.l_l, box.get_right(candle.body), candle.l)
                            label.set_text(htf_trace.l_l, str.tostring(candle.l))
    candleSet


// ══════════════════════════════════════════════════════════════════════════════
// WATERMARK TEXT CONSTRUCTION
// ══════════════════════════════════════════════════════════════════════════════

// Build Line 1 (Title) - symbol, timeframe, and/or custom title
var string line1Text = ""

if showWatermark
    line1Text := ""

    if showSymbol
        line1Text += syminfo.ticker

    if showTimeframe
        if showSymbol
            line1Text += " | "
        line1Text += timeframe.period

    if titleText != ""
        if showSymbol or showTimeframe
            line1Text += " | "
        line1Text += titleText

// Build Line 2 (Subtitles) - up to 3 subtitle cells with pipe separators
var string line2Text = ""

if showWatermark
    line2Text := ""

    if subtitle1 != ""
        line2Text += subtitle1

    if subtitle2 != ""
        if subtitle1 != ""
            line2Text += " | "
        line2Text += subtitle2

    if subtitle3 != ""
        if subtitle1 != "" or subtitle2 != ""
            line2Text += " | "
        line2Text += subtitle3


// ══════════════════════════════════════════════════════════════════════════════
// WATERMARK TABLE RENDERING
// ══════════════════════════════════════════════════════════════════════════════

// Determine table position based on position setting
var string tablePosition = position == "Left" ? position.top_left : position == "Right" ? position.top_right : position.top_center

// Determine horizontal alignment
var string hAlign = position == "Left" ? text.align_left : position == "Right" ? text.align_right : text.align_center

// Create persistent table
var table watermarkTable = table.new(position=tablePosition, columns=1, rows=2, bgcolor=color.new(color.black, 100), frame_width=0, border_width=0)

// Apply transparency to text color
watermarkTextColor = color.new(textColor, transparency)

// Update on last bar for optimal performance
if barstate.islast
    if showWatermark
        if line1Text != ""
            table.cell(watermarkTable, column=0, row=0, text=line1Text, text_color=watermarkTextColor, text_size=fontSize, text_halign=hAlign, bgcolor=color.new(color.black, 100))
        else
            table.cell(watermarkTable, column=0, row=0, text="", bgcolor=color.new(color.black, 100))

        if line2Text != ""
            table.cell(watermarkTable, column=0, row=1, text=line2Text, text_color=watermarkTextColor, text_size=fontSize, text_halign=hAlign, bgcolor=color.new(color.black, 100))
        else
            table.cell(watermarkTable, column=0, row=1, text="", bgcolor=color.new(color.black, 100))
    else
        table.cell(watermarkTable, column=0, row=0, text="", bgcolor=color.new(color.black, 100))
        table.cell(watermarkTable, column=0, row=1, text="", bgcolor=color.new(color.black, 100))


// ══════════════════════════════════════════════════════════════════════════════
// STATUS DASHBOARD - TABLE RENDERING
// ══════════════════════════════════════════════════════════════════════════════

var table statusTable = na

if show_status_dashboard and barstate.islast
    // Detect current feature states
    watermark_enabled = showWatermark
    sessions_enabled = showSessions
    killzones_enabled = showKillZones
    prev_period_enabled = show_daily_hl or show_weekly_hl or show_monthly_hl
    htf_enabled = htf1.settings.show or htf2.settings.show or htf3.settings.show or htf4.settings.show or htf5.settings.show

    // Create table if not exists
    if na(statusTable)
        statusTable := table.new(get_status_position(status_position), 2, 6)

    // Background color with user-defined transparency
    bg_color = color.new(color.gray, status_bg_transp)

    // Header row (row 0)
    table.cell(statusTable, 0, 0, "FEATURE STATUS", text_color=color.white, text_size=size.small, bgcolor=bg_color)
    table.cell(statusTable, 1, 0, "", bgcolor=bg_color)

    // Watermark row (row 1)
    table.cell(statusTable, 0, 1, "Watermark", text_color=color.white, text_size=size.small, bgcolor=bg_color)
    table.cell(statusTable, 1, 1, watermark_enabled ? "✓" : "✗", text_color=watermark_enabled ? color.green : color.red, text_size=size.normal, bgcolor=bg_color)

    // Sessions row (row 2)
    table.cell(statusTable, 0, 2, "Sessions", text_color=color.white, text_size=size.small, bgcolor=bg_color)
    table.cell(statusTable, 1, 2, sessions_enabled ? "✓" : "✗", text_color=sessions_enabled ? color.green : color.red, text_size=size.normal, bgcolor=bg_color)

    // Kill Zones row (row 3)
    table.cell(statusTable, 0, 3, "Kill Zones", text_color=color.white, text_size=size.small, bgcolor=bg_color)
    table.cell(statusTable, 1, 3, killzones_enabled ? "✓" : "✗", text_color=killzones_enabled ? color.green : color.red, text_size=size.normal, bgcolor=bg_color)

    // Previous Period row (row 4)
    table.cell(statusTable, 0, 4, "Previous Period", text_color=color.white, text_size=size.small, bgcolor=bg_color)
    table.cell(statusTable, 1, 4, prev_period_enabled ? "✓" : "✗", text_color=prev_period_enabled ? color.green : color.red, text_size=size.normal, bgcolor=bg_color)

    // HTF Candles row (row 5)
    table.cell(statusTable, 0, 5, "HTF Candles", text_color=color.white, text_size=size.small, bgcolor=bg_color)
    table.cell(statusTable, 1, 5, htf_enabled ? "✓" : "✗", text_color=htf_enabled ? color.green : color.red, text_size=size.normal, bgcolor=bg_color)


// ══════════════════════════════════════════════════════════════════════════════
// SESSION DETECTION (INSPIRATION APPROACH)
// ══════════════════════════════════════════════════════════════════════════════

// Use Pine's native time() function for robust session detection
tf = timeframe.period

is_asian = (showSessions and show_asian) ? math.sign(nz(time(tf, asian_ses, gmt_tz))) : 0.0
is_london = (showSessions and show_london) ? math.sign(nz(time(tf, london_ses, gmt_tz))) : 0.0
is_ny = (showSessions and show_ny) ? math.sign(nz(time(tf, ny_ses, gmt_tz))) : 0.0


// ══════════════════════════════════════════════════════════════════════════════
// PREVIOUS PERIOD H/L DATA RETRIEVAL
// ══════════════════════════════════════════════════════════════════════════════

// Request higher timeframe data for daily, weekly, and monthly periods
[daily_time, daily_high, daily_low, is_last_daily] = request.security(syminfo.tickerid, 'D', [time, high, low, barstate.islast], lookahead=barmerge.lookahead_on)
[weekly_time, weekly_high, weekly_low, is_last_weekly] = request.security(syminfo.tickerid, 'W', [time, high, low, barstate.islast], lookahead=barmerge.lookahead_on)
[monthly_time, monthly_high, monthly_low, is_last_monthly] = request.security(syminfo.tickerid, 'M', [time, high, low, barstate.islast], lookahead=barmerge.lookahead_on)

// Detect period changes
has_daily_changed = daily_time != daily_time[1]
has_weekly_changed = weekly_time != weekly_time[1]
has_monthly_changed = monthly_time != monthly_time[1]


// ══════════════════════════════════════════════════════════════════════════════
// SESSION RANGE BOXES (INSPIRATION-STYLE WITH ARRAYS)
// ══════════════════════════════════════════════════════════════════════════════

// Session range tracking function (inspired by LuxAlgo)
get_session_range(session, session_name, session_css) =>
    var int t = 0
    var float max = high
    var float min = low
    var box bx = na
    var label lbl = na
    var array<box> box_array = array.new<box>()
    var array<label> label_array = array.new<label>()

    if session > session[1]
        t := time
        max := high
        min := low

        bx := box.new(bar_index, max, bar_index, min, bgcolor=color.new(session_css, session_bg_transp), border_color=show_session_outline ? session_css : na, border_style=line.style_dotted)

        box_array.unshift(bx)

        if show_session_labels
            lbl := label.new(time, max, session_name, xloc=xloc.bar_time, textcolor=session_css, style=label.style_label_down, color=color.new(color.white, 100), size=size.tiny)
            label_array.unshift(lbl)

        // Drawing limit management
        if box_array.size() > max_days
            old_box = box_array.pop()
            box.delete(old_box)

        if label_array.size() > max_days
            old_label = label_array.pop()
            label.delete(old_label)

    if session > 0 and session == session[1]
        max := math.max(high, max)
        min := math.min(low, min)

        if not na(bx)
            box.set_top(bx, max)
            box.set_rightbottom(bx, bar_index, min)

        if show_session_labels and not na(lbl)
            label.set_xy(lbl, int(math.avg(t, time)), max)

    [session > 0 ? na : max, session > 0 ? na : min]

// Apply session ranges
if show_session_range
    [asian_max, asian_min] = get_session_range(is_asian, asian_txt, asian_css)
    [london_max, london_min] = get_session_range(is_london, london_txt, london_css)
    [ny_max, ny_min] = get_session_range(is_ny, ny_txt, ny_css)


// ══════════════════════════════════════════════════════════════════════════════
// SESSION HIGH/LOW LINES (INSPIRATION APPROACH)
// ══════════════════════════════════════════════════════════════════════════════

// Track session highs/lows with arrays for multi-day support
var array<line> asian_hi_lines = array.new<line>()
var array<line> asian_lo_lines = array.new<line>()
var array<label> asian_hi_labels = array.new<label>()
var array<label> asian_lo_labels = array.new<label>()

var array<line> london_hi_lines = array.new<line>()
var array<line> london_lo_lines = array.new<line>()
var array<label> london_hi_labels = array.new<label>()
var array<label> london_lo_labels = array.new<label>()

var array<line> ny_hi_lines = array.new<line>()
var array<line> ny_lo_lines = array.new<line>()
var array<label> ny_hi_labels = array.new<label>()
var array<label> ny_lo_labels = array.new<label>()

// Session high/low tracking function
track_session_hl(session, hi_lines, lo_lines, hi_labels, lo_labels, sess_name, sess_color) =>
    var float sess_high = na
    var float sess_low = na
    var int sess_start = na
    var line hi_ln = na
    var line lo_ln = na
    var label hi_lb = na
    var label lo_lb = na

    if session > session[1]
        sess_high := high
        sess_low := low
        sess_start := bar_index

        if show_session_highs
            hi_ln := line.new(sess_start, sess_high, bar_index, sess_high, color=sess_color, width=session_line_width, style=get_line_style())
            lo_ln := line.new(sess_start, sess_low, bar_index, sess_low, color=sess_color, width=session_line_width, style=get_line_style())

            hi_lines.unshift(hi_ln)
            lo_lines.unshift(lo_ln)

            hi_lb := label.new(bar_index, sess_high, sess_name + " H", color=color.new(color.black, 100), textcolor=sess_color, size=size.small, style=get_label_style())
            lo_lb := label.new(bar_index, sess_low, sess_name + " L", color=color.new(color.black, 100), textcolor=sess_color, size=size.small, style=get_label_style())

            hi_labels.unshift(hi_lb)
            lo_labels.unshift(lo_lb)

            // Drawing limit management
            if hi_lines.size() > max_days
                old_hi = hi_lines.pop()
                old_lo = lo_lines.pop()
                line.delete(old_hi)
                line.delete(old_lo)

            if hi_labels.size() > max_days
                old_hi_lb = hi_labels.pop()
                old_lo_lb = lo_labels.pop()
                label.delete(old_hi_lb)
                label.delete(old_lo_lb)

    if session > 0 and session == session[1]
        if high > sess_high
            sess_high := high
            if show_session_highs and not na(hi_ln)
                line.set_y1(hi_ln, sess_high)
                line.set_y2(hi_ln, sess_high)
                if not na(hi_lb)
                    label.set_y(hi_lb, sess_high)

        if low < sess_low
            sess_low := low
            if show_session_highs and not na(lo_ln)
                line.set_y1(lo_ln, sess_low)
                line.set_y2(lo_ln, sess_low)
                if not na(lo_lb)
                    label.set_y(lo_lb, sess_low)

        if show_session_highs and not na(hi_ln)
            line.set_x2(hi_ln, bar_index)
            line.set_x2(lo_ln, bar_index)
            if not na(hi_lb)
                label.set_x(hi_lb, bar_index)
                label.set_x(lo_lb, bar_index)

// Apply session high/low tracking
track_session_hl(is_asian, asian_hi_lines, asian_lo_lines, asian_hi_labels, asian_lo_labels, asian_txt, asian_css)
track_session_hl(is_london, london_hi_lines, london_lo_lines, london_hi_labels, london_lo_labels, london_txt, london_css)
track_session_hl(is_ny, ny_hi_lines, ny_lo_lines, ny_hi_labels, ny_lo_labels, ny_txt, ny_css)


// ══════════════════════════════════════════════════════════════════════════════
// PREVIOUS PERIOD H/L DRAWING FUNCTION
// ══════════════════════════════════════════════════════════════════════════════

// Track and draw period high/low lines with array management and labels
track_period_hl(is_new_period, period_high, period_low, is_last, lookback, period_color, line_style_func, line_width, hi_lines, lo_lines, hi_labels, lo_labels, high_label_text, low_label_text) =>
    var line hi_ln = na
    var line lo_ln = na
    var label hi_lb = na
    var label lo_lb = na

    if is_new_period and not is_last
        // Create new lines for this period
        hi_ln := line.new(bar_index, period_high, bar_index, period_high, color=period_color, style=line_style_func, width=line_width)
        lo_ln := line.new(bar_index, period_low, bar_index, period_low, color=period_color, style=line_style_func, width=line_width)

        // Create labels if enabled
        if show_period_labels
            hi_lb := label.new(bar_index, period_high, high_label_text, color=color.new(color.black, 100), textcolor=period_color, size=size.small, style=get_period_label_style())
            lo_lb := label.new(bar_index, period_low, low_label_text, color=color.new(color.black, 100), textcolor=period_color, size=size.small, style=get_period_label_style())

        // Add to arrays
        hi_lines.unshift(hi_ln)
        lo_lines.unshift(lo_ln)
        if show_period_labels
            hi_labels.unshift(hi_lb)
            lo_labels.unshift(lo_lb)

        // Manage lookback limit
        if hi_lines.size() > lookback
            old_hi = hi_lines.pop()
            old_lo = lo_lines.pop()
            line.delete(old_hi)
            line.delete(old_lo)

        if show_period_labels and hi_labels.size() > lookback
            old_hi_lb = hi_labels.pop()
            old_lo_lb = lo_labels.pop()
            label.delete(old_hi_lb)
            label.delete(old_lo_lb)

    // Extend lines to current bar
    if hi_lines.size() > 0
        for i = 0 to hi_lines.size() - 1
            line.set_x2(hi_lines.get(i), bar_index)
            line.set_x2(lo_lines.get(i), bar_index)
            if show_period_labels and hi_labels.size() > i and lo_labels.size() > i
                label.set_x(hi_labels.get(i), bar_index)
                label.set_x(lo_labels.get(i), bar_index)


// ══════════════════════════════════════════════════════════════════════════════
// SESSION OPEN/CLOSE MARKERS
// ══════════════════════════════════════════════════════════════════════════════

if show_session_open
    if is_asian > 0 and is_asian[1] == 0
        line.new(bar_index, low, bar_index, high, color=asian_css, width=1, style=line.style_dotted)
    if is_london > 0 and is_london[1] == 0
        line.new(bar_index, low, bar_index, high, color=london_css, width=1, style=line.style_dotted)
    if is_ny > 0 and is_ny[1] == 0
        line.new(bar_index, low, bar_index, high, color=ny_css, width=1, style=line.style_dotted)

if show_session_close
    if is_asian == 0 and is_asian[1] > 0
        line.new(bar_index, low, bar_index, high, color=asian_css, width=1, style=line.style_dotted)
    if is_london == 0 and is_london[1] > 0
        line.new(bar_index, low, bar_index, high, color=london_css, width=1, style=line.style_dotted)
    if is_ny == 0 and is_ny[1] > 0
        line.new(bar_index, low, bar_index, high, color=ny_css, width=1, style=line.style_dotted)


// ══════════════════════════════════════════════════════════════════════════════
// KILL ZONE DETECTION (INSPIRATION APPROACH)
// ══════════════════════════════════════════════════════════════════════════════

is_asian_kz = (showKillZones and use_asian_kz) ? math.sign(nz(time(tf, asian_kz_ses, gmt_tz))) : 0.0
is_london_kz = (showKillZones and use_london_kz) ? math.sign(nz(time(tf, london_kz_ses, gmt_tz))) : 0.0
is_nyam_kz = (showKillZones and use_nyam_kz) ? math.sign(nz(time(tf, nyam_kz_ses, gmt_tz))) : 0.0
is_nylu_kz = (showKillZones and use_nylu_kz) ? math.sign(nz(time(tf, nylu_kz_ses, gmt_tz))) : 0.0
is_nypm_kz = (showKillZones and use_nypm_kz) ? math.sign(nz(time(tf, nypm_kz_ses, gmt_tz))) : 0.0


// ══════════════════════════════════════════════════════════════════════════════
// KILL ZONE BOXES (ARRAY-BASED WITH DRAWING LIMITS)
// ══════════════════════════════════════════════════════════════════════════════

// Kill zone tracking function with array management
track_killzone(kz_session, kz_txt, kz_color) =>
    var int kz_start = na
    var float kz_high = na
    var float kz_low = na
    var box kz_box = na
    var label kz_label = na
    var array<box> kz_boxes = array.new<box>()
    var array<label> kz_labels = array.new<label>()

    if kz_session > kz_session[1]
        kz_start := bar_index
        kz_high := high
        kz_low := low

        box_color = color.new(kz_color, kz_box_transp)
        kz_box := box.new(kz_start, kz_high, bar_index, kz_low, bgcolor=box_color, border_color=box_color, border_width=1)
        kz_boxes.unshift(kz_box)

        if show_kz_text and kz_txt != ""
            text_color = color.new(color.white, kz_text_transp)
            kz_label := label.new(bar_index, kz_high, kz_txt, color=box_color, textcolor=text_color, size=size.small, style=label.style_label_down)
            kz_labels.unshift(kz_label)

        // Drawing limit management
        if kz_boxes.size() > max_days
            old_box = kz_boxes.pop()
            box.delete(old_box)

        if kz_labels.size() > max_days
            old_label = kz_labels.pop()
            label.delete(old_label)

    if kz_session > 0 and kz_session == kz_session[1]
        if high > kz_high
            kz_high := high
        if low < kz_low
            kz_low := low

        if not na(kz_box)
            box.set_top(kz_box, kz_high)
            box.set_bottom(kz_box, kz_low)
            box.set_right(kz_box, bar_index)

        if show_kz_text and not na(kz_label)
            label.set_xy(kz_label, bar_index, kz_high)

// Apply kill zone tracking
track_killzone(is_asian_kz, asian_kz_txt, asian_kz_css)
track_killzone(is_london_kz, london_kz_txt, london_kz_css)
track_killzone(is_nyam_kz, nyam_kz_txt, nyam_kz_css)
track_killzone(is_nylu_kz, nylu_kz_txt, nylu_kz_css)
track_killzone(is_nypm_kz, nypm_kz_txt, nypm_kz_css)


// ══════════════════════════════════════════════════════════════════════════════
// PREVIOUS PERIOD H/L RENDERING
// ══════════════════════════════════════════════════════════════════════════════

// Initialize arrays for period high/low lines and labels
var array<line> daily_hi_lines = array.new<line>()
var array<line> daily_lo_lines = array.new<line>()
var array<label> daily_hi_labels = array.new<label>()
var array<label> daily_lo_labels = array.new<label>()

var array<line> weekly_hi_lines = array.new<line>()
var array<line> weekly_lo_lines = array.new<line>()
var array<label> weekly_hi_labels = array.new<label>()
var array<label> weekly_lo_labels = array.new<label>()

var array<line> monthly_hi_lines = array.new<line>()
var array<line> monthly_lo_lines = array.new<line>()
var array<label> monthly_hi_labels = array.new<label>()
var array<label> monthly_lo_labels = array.new<label>()

// Apply period high/low tracking
if show_prev_periods
    // Daily H/L (only on intraday timeframes)
    if show_daily_hl and timeframe.isintraday
        track_period_hl(has_daily_changed, daily_high, daily_low, is_last_daily, daily_lookback, daily_color, get_period_line_style(daily_line_style), daily_line_width, daily_hi_lines, daily_lo_lines, daily_hi_labels, daily_lo_labels, daily_high_label, daily_low_label)

    // Weekly H/L (on intraday and daily timeframes)
    if show_weekly_hl and (timeframe.isintraday or timeframe.isdaily)
        track_period_hl(has_weekly_changed, weekly_high, weekly_low, is_last_weekly, weekly_lookback, weekly_color, get_period_line_style(weekly_line_style), weekly_line_width, weekly_hi_lines, weekly_lo_lines, weekly_hi_labels, weekly_lo_labels, weekly_high_label, weekly_low_label)

    // Monthly H/L (not on monthly timeframes)
    if show_monthly_hl and not timeframe.ismonthly
        track_period_hl(has_monthly_changed, monthly_high, monthly_low, is_last_monthly, monthly_lookback, monthly_color, get_period_line_style(monthly_line_style), monthly_line_width, monthly_hi_lines, monthly_lo_lines, monthly_hi_labels, monthly_lo_labels, monthly_high_label, monthly_low_label)


// ══════════════════════════════════════════════════════════════════════════════
// HTF CANDLES - MAIN EXECUTION
// ══════════════════════════════════════════════════════════════════════════════

int htf_cnt = 0
int htf_last = HTFEnabled()
int htf_offset = htf_settings.offset

if show_htf_candles and htf1.settings.show and ValidTimeframe(htf1.settings.htf)
    bool showTrace = false
    if htf_settings.trace_anchor == 'First Timeframe'
        showTrace := true
        showTrace
    if htf_settings.trace_anchor == 'Last Timeframe' and htf_settings.max_sets == 1
        showTrace := true
        showTrace
    htf1.UpdateTime(htf_offset)
    htf1.Monitor().Update(htf_offset, showTrace).FindImbalance()
    htf_cnt := htf_cnt + 1
    htf_offset := htf_offset + (htf_cnt > 0 ? htf1.candles.size() * htf_settings.width + (htf1.candles.size() > 0 ? (htf1.candles.size() - 1) * htf_settings.buffer : 0) + htf_settings.htf_buffer : 0)
    htf_offset

if show_htf_candles and htf2.settings.show and ValidTimeframe(htf2.settings.htf) and htf_cnt < htf_last
    bool showTrace = false
    if htf_settings.trace_anchor == 'First Timeframe' and htf_cnt == 0
        showTrace := true
        showTrace
    if htf_settings.trace_anchor == 'Last Timeframe' and htf_cnt == htf_last - 1
        showTrace := true
        showTrace
    htf2.UpdateTime(htf_offset)
    htf2.Monitor().Update(htf_offset, showTrace).FindImbalance()
    htf_cnt := htf_cnt + 1
    htf_offset := htf_offset + (htf_cnt > 0 ? htf2.candles.size() * htf_settings.width + (htf2.candles.size() > 0 ? (htf2.candles.size() - 1) * htf_settings.buffer : 0) + htf_settings.htf_buffer : 0)
    htf_offset

if show_htf_candles and htf3.settings.show and ValidTimeframe(htf3.settings.htf) and htf_cnt < htf_last
    bool showTrace = false
    if htf_settings.trace_anchor == 'First Timeframe' and htf_cnt == 0
        showTrace := true
        showTrace
    if htf_settings.trace_anchor == 'Last Timeframe' and htf_cnt == htf_last - 1
        showTrace := true
        showTrace
    htf3.UpdateTime(htf_offset)
    htf3.Monitor().Update(htf_offset, showTrace).FindImbalance()
    htf_cnt := htf_cnt + 1
    htf_offset := htf_offset + (htf_cnt > 0 ? htf3.candles.size() * htf_settings.width + (htf3.candles.size() > 0 ? (htf3.candles.size() - 1) * htf_settings.buffer : 0) + htf_settings.htf_buffer : 0)
    htf_offset

if show_htf_candles and htf4.settings.show and ValidTimeframe(htf4.settings.htf) and htf_cnt < htf_last
    bool showTrace = false
    if htf_settings.trace_anchor == 'First Timeframe' and htf_cnt == 0
        showTrace := true
        showTrace
    if htf_settings.trace_anchor == 'Last Timeframe' and htf_cnt == htf_last - 1
        showTrace := true
        showTrace
    htf4.UpdateTime(htf_offset)
    htf4.Monitor().Update(htf_offset, showTrace).FindImbalance()
    htf_cnt := htf_cnt + 1
    htf_offset := htf_offset + (htf_cnt > 0 ? htf4.candles.size() * htf_settings.width + (htf4.candles.size() > 0 ? (htf4.candles.size() - 1) * htf_settings.buffer : 0) + htf_settings.htf_buffer : 0)
    htf_offset

if show_htf_candles and htf5.settings.show and ValidTimeframe(htf5.settings.htf) and htf_cnt < htf_last
    bool showTrace = false
    if htf_settings.trace_anchor == 'First Timeframe' and htf_cnt == 0
        showTrace := true
        showTrace
    if htf_settings.trace_anchor == 'Last Timeframe' and htf_cnt == htf_last - 1
        showTrace := true
        showTrace
    htf5.UpdateTime(htf_offset)
    htf5.Monitor().Update(htf_offset, showTrace).FindImbalance()
    htf_cnt := htf_cnt + 1
    htf_offset := htf_offset + (htf_cnt > 0 ? htf5.candles.size() * htf_settings.width + (htf5.candles.size() > 0 ? (htf5.candles.size() - 1) * htf_settings.buffer : 0) + htf_settings.htf_buffer : 0)
    htf_offset


// ══════════════════════════════════════════════════════════════════════════════
// END OF OBSIDIAN v3.2.0
// ══════════════════════════════════════════════════════════════════════════════